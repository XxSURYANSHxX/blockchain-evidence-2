<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Timeline | EVID-DGC</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="config.js"></script>
    <script src="storage.js"></script>
</head>
<body>
    <header class="header-nav">
        <div class="navbar-container">
            <div class="nav-brand">
                <i data-lucide="shield-check" class="brand-icon"></i>
                <span>EVID-DGC</span>
            </div>
            <nav class="nav-menu">
                <a href="dashboard.html" class="nav-link">
                    <i data-lucide="arrow-left"></i>
                    <span>Back to Dashboard</span>
                </a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">
                    <i data-lucide="clock"></i>
                </div>
                <h1 id="caseTitle">Case Timeline</h1>
                <p id="caseDescription">Chronological view of all case events and activities</p>
            </div>
            <div class="card-body">
                <div class="timeline-controls">
                    <div class="timeline-filters">
                        <select id="eventTypeFilter" class="form-control">
                            <option value="all">All Events</option>
                            <option value="evidence">Evidence Added</option>
                            <option value="custody">Chain of Custody</option>
                            <option value="status">Status Changes</option>
                            <option value="access">Access Logs</option>
                            <option value="approval">Approvals</option>
                        </select>
                        <select id="roleFilter" class="form-control">
                            <option value="all">All Roles</option>
                            <option value="investigator">Investigator</option>
                            <option value="forensic_analyst">Forensic Analyst</option>
                            <option value="legal_professional">Legal Professional</option>
                            <option value="court_official">Court Official</option>
                            <option value="evidence_manager">Evidence Manager</option>
                            <option value="auditor">Auditor</option>
                        </select>
                        <input type="date" id="dateFilter" class="form-control" placeholder="Filter by date">
                        <button onclick="clearFilters()" class="btn btn-outline">
                            <i data-lucide="x"></i>
                            Clear Filters
                        </button>
                    </div>
                    <div class="timeline-actions">
                        <button onclick="exportTimeline()" class="btn btn-primary">
                            <i data-lucide="download"></i>
                            Export Timeline
                        </button>
                        <button onclick="printTimeline()" class="btn btn-outline">
                            <i data-lucide="printer"></i>
                            Print
                        </button>
                    </div>
                </div>

                <div class="timeline-container" id="timelineContainer">
                    <div class="vertical-timeline" id="verticalTimeline">
                        <!-- Timeline events will be populated here -->
                    </div>
                </div>

                <div class="timeline-summary">
                    <h3>Timeline Summary</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <i data-lucide="activity"></i>
                            <span id="totalEvents">0</span>
                            <span>Total Events</span>
                        </div>
                        <div class="stat-item">
                            <i data-lucide="users"></i>
                            <span id="uniqueActors">0</span>
                            <span>Unique Actors</span>
                        </div>
                        <div class="stat-item">
                            <i data-lucide="calendar"></i>
                            <span id="timeSpan">0</span>
                            <span>Days Active</span>
                        </div>
                        <div class="stat-item">
                            <i data-lucide="file"></i>
                            <span id="evidenceCount">0</span>
                            <span>Evidence Items</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample timeline data - in real implementation, this would come from API
        const sampleTimelineData = [
            {
                id: 1,
                type: 'case_created',
                title: 'Case Created',
                description: 'Initial case file created and assigned case number',
                actor: 'Det. Sarah Smith',
                role: 'investigator',
                timestamp: '2024-01-15T09:30:00Z',
                details: {
                    case_number: '2024-DF-001',
                    priority: 'High',
                    assigned_to: 'Det. Sarah Smith'
                },
                blockchain_tx: '0xa1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456'
            },
            {
                id: 2,
                type: 'evidence',
                title: 'Email Evidence Added',
                description: '5 suspicious email messages extracted and verified',
                actor: 'Dr. Michael Johnson',
                role: 'forensic_analyst',
                timestamp: '2024-01-15T10:15:00Z',
                details: {
                    evidence_count: 5,
                    file_types: ['eml'],
                    total_size: '2.3 MB'
                },
                blockchain_tx: '0xb2c3d4e5f6789012345678901234567890abcdef1234567890abcdef234567',
                evidence_links: [
                    { id: 101, name: 'phishing_email_001.eml' },
                    { id: 102, name: 'suspicious_reply_002.eml' }
                ]
            },
            {
                id: 3,
                type: 'custody',
                title: 'Chain of Custody Transfer',
                description: 'Evidence transferred from Forensic Analyst to Legal Professional',
                actor: 'System',
                role: 'system',
                timestamp: '2024-01-16T08:00:00Z',
                details: {
                    from_role: 'forensic_analyst',
                    to_role: 'legal_professional',
                    evidence_ids: [101, 102, 103, 104, 105]
                },
                blockchain_tx: '0xc3d4e5f6789012345678901234567890abcdef1234567890abcdef345678'
            },
            {
                id: 4,
                type: 'evidence',
                title: 'Screenshot Evidence Added',
                description: 'Banking transaction screenshots and account access logs',
                actor: 'Det. Sarah Smith',
                role: 'investigator',
                timestamp: '2024-01-16T14:20:00Z',
                details: {
                    evidence_count: 8,
                    file_types: ['png', 'jpg'],
                    total_size: '15.7 MB'
                },
                blockchain_tx: '0xd4e5f6789012345678901234567890abcdef1234567890abcdef456789',
                evidence_links: [
                    { id: 106, name: 'transaction_log_screenshot.png' },
                    { id: 107, name: 'account_access_log.png' }
                ]
            },
            {
                id: 5,
                type: 'access',
                title: 'Case Accessed',
                description: 'Legal Professional reviewed case files and evidence',
                actor: 'Atty. Jennifer Williams',
                role: 'legal_professional',
                timestamp: '2024-01-17T09:45:00Z',
                details: {
                    access_type: 'read',
                    duration: '45 minutes',
                    files_accessed: 13
                }
            },
            {
                id: 6,
                type: 'evidence',
                title: 'Digital Forensics Analysis',
                description: 'Complete forensic analysis of suspect devices',
                actor: 'Dr. Michael Johnson',
                role: 'forensic_analyst',
                timestamp: '2024-01-17T11:00:00Z',
                details: {
                    evidence_count: 5,
                    file_types: ['dd', 'zip', 'log'],
                    total_size: '2.1 GB'
                },
                blockchain_tx: '0xe5f6789012345678901234567890abcdef1234567890abcdef567890',
                evidence_links: [
                    { id: 108, name: 'computer_disk_image.dd' },
                    { id: 109, name: 'mobile_data_extract.zip' }
                ]
            },
            {
                id: 7,
                type: 'approval',
                title: 'Legal Review Completed',
                description: 'All evidence approved for court presentation',
                actor: 'Atty. Jennifer Williams',
                role: 'legal_professional',
                timestamp: '2024-01-18T11:45:00Z',
                details: {
                    status: 'approved',
                    evidence_reviewed: 22,
                    admissibility: 'confirmed'
                },
                blockchain_tx: '0xf6789012345678901234567890abcdef1234567890abcdef678901'
            },
            {
                id: 8,
                type: 'status',
                title: 'Case Status Updated',
                description: 'Case status changed from "Under Investigation" to "Ready for Court"',
                actor: 'Atty. Jennifer Williams',
                role: 'legal_professional',
                timestamp: '2024-01-19T16:30:00Z',
                details: {
                    previous_status: 'Under Investigation',
                    new_status: 'Ready for Court',
                    reason: 'All evidence reviewed and approved'
                },
                blockchain_tx: '0x789012345678901234567890abcdef1234567890abcdef789012'
            },
            {
                id: 9,
                type: 'custody',
                title: 'Court Submission',
                description: 'Evidence package submitted to court system',
                actor: 'Judge Robert Davis',
                role: 'court_official',
                timestamp: '2024-01-20T09:00:00Z',
                details: {
                    court_case: 'CR-2024-001234',
                    submission_type: 'digital_evidence_package',
                    total_items: 22
                },
                blockchain_tx: '0x89012345678901234567890abcdef1234567890abcdef890123'
            },
            {
                id: 10,
                type: 'access',
                title: 'Audit Review',
                description: 'Complete audit of case handling and evidence integrity',
                actor: 'Ms. Patricia Chen',
                role: 'auditor',
                timestamp: '2024-01-22T15:30:00Z',
                details: {
                    audit_type: 'compliance_review',
                    findings: 'no_issues',
                    recommendations: 'none'
                }
            }
        ];

        let filteredData = [...sampleTimelineData];

        function initializeTimeline() {
            renderTimeline(filteredData);
            updateSummaryStats(filteredData);
            setupEventListeners();
        }

        function renderTimeline(data) {
            const timeline = document.getElementById('verticalTimeline');
            timeline.innerHTML = '';

            data.forEach((event, index) => {
                const timelineEvent = createTimelineEvent(event, index);
                timeline.appendChild(timelineEvent);
            });
        }

        function createTimelineEvent(event, index) {
            const eventElement = document.createElement('div');
            eventElement.className = 'timeline-event';
            eventElement.setAttribute('data-type', event.type);
            eventElement.setAttribute('data-role', event.role);

            const date = new Date(event.timestamp);
            const formattedDate = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            const formattedTime = date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });

            eventElement.innerHTML = `
                <div class="timeline-marker ${event.type}">
                    <i data-lucide="${getEventIcon(event.type)}"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-header">
                        <h3>${event.title}</h3>
                        <div class="timeline-meta">
                            <span class="timeline-date">${formattedDate} ${formattedTime}</span>
                            <span class="timeline-role badge badge-${event.role}">${formatRole(event.role)}</span>
                        </div>
                    </div>
                    <div class="timeline-body">
                        <p><strong>Actor:</strong> ${event.actor}</p>
                        <p>${event.description}</p>
                        ${renderEventDetails(event)}
                        ${event.evidence_links ? renderEvidenceLinks(event.evidence_links) : ''}
                        ${event.blockchain_tx ? `
                            <div class="blockchain-proof">
                                <i data-lucide="link"></i>
                                <span>Blockchain Tx: ${event.blockchain_tx}</span>
                                <button onclick="verifyTransaction('${event.blockchain_tx}')" class="btn btn-sm btn-outline">
                                    <i data-lucide="external-link"></i>
                                    Verify
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            return eventElement;
        }

        function getEventIcon(type) {
            const icons = {
                'case_created': 'folder-plus',
                'evidence': 'upload',
                'custody': 'arrow-right-left',
                'status': 'flag',
                'access': 'eye',
                'approval': 'check-circle',
                'system': 'settings'
            };
            return icons[type] || 'circle';
        }

        function formatRole(role) {
            return role.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function renderEventDetails(event) {
            if (!event.details) return '';

            let detailsHtml = '<div class="event-details">';
            for (const [key, value] of Object.entries(event.details)) {
                const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                detailsHtml += `<div class="detail-item"><strong>${formattedKey}:</strong> ${value}</div>`;
            }
            detailsHtml += '</div>';
            return detailsHtml;
        }

        function renderEvidenceLinks(links) {
            let linksHtml = '<div class="evidence-links"><h4>Related Evidence:</h4><ul>';
            links.forEach(link => {
                linksHtml += `<li><a href="#" onclick="viewEvidence(${link.id})">${link.name}</a></li>`;
            });
            linksHtml += '</ul></div>';
            return linksHtml;
        }

        function setupEventListeners() {
            document.getElementById('eventTypeFilter').addEventListener('change', applyFilters);
            document.getElementById('roleFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const typeFilter = document.getElementById('eventTypeFilter').value;
            const roleFilter = document.getElementById('roleFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            filteredData = sampleTimelineData.filter(event => {
                let matches = true;

                if (typeFilter !== 'all' && event.type !== typeFilter) {
                    matches = false;
                }

                if (roleFilter !== 'all' && event.role !== roleFilter) {
                    matches = false;
                }

                if (dateFilter) {
                    const eventDate = new Date(event.timestamp).toISOString().split('T')[0];
                    if (eventDate !== dateFilter) {
                        matches = false;
                    }
                }

                return matches;
            });

            renderTimeline(filteredData);
            updateSummaryStats(filteredData);
        }

        function clearFilters() {
            document.getElementById('eventTypeFilter').value = 'all';
            document.getElementById('roleFilter').value = 'all';
            document.getElementById('dateFilter').value = '';
            filteredData = [...sampleTimelineData];
            renderTimeline(filteredData);
            updateSummaryStats(filteredData);
        }

        function updateSummaryStats(data) {
            document.getElementById('totalEvents').textContent = data.length;
            
            const uniqueActors = new Set(data.map(event => event.actor)).size;
            document.getElementById('uniqueActors').textContent = uniqueActors;

            const evidenceEvents = data.filter(event => event.type === 'evidence');
            const evidenceCount = evidenceEvents.reduce((total, event) => {
                return total + (event.details?.evidence_count || 0);
            }, 0);
            document.getElementById('evidenceCount').textContent = evidenceCount;

            if (data.length > 0) {
                const timestamps = data.map(event => new Date(event.timestamp));
                const earliest = new Date(Math.min(...timestamps));
                const latest = new Date(Math.max(...timestamps));
                const daysDiff = Math.ceil((latest - earliest) / (1000 * 60 * 60 * 24));
                document.getElementById('timeSpan').textContent = daysDiff;
            } else {
                document.getElementById('timeSpan').textContent = '0';
            }
        }

        function exportTimeline() {
            const timelineData = {
                case_id: 'DEMO-001',
                export_timestamp: new Date().toISOString(),
                events: filteredData,
                summary: {
                    total_events: filteredData.length,
                    unique_actors: new Set(filteredData.map(e => e.actor)).size,
                    evidence_count: filteredData.filter(e => e.type === 'evidence').length
                }
            };

            const dataStr = JSON.stringify(timelineData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `case_timeline_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function printTimeline() {
            window.print();
        }

        function verifyTransaction(txHash) {
            // In real implementation, this would open blockchain explorer
            alert(`Verifying transaction: ${txHash}\n\nThis would open the blockchain explorer to verify the transaction.`);
        }

        function viewEvidence(evidenceId) {
            // In real implementation, this would navigate to evidence detail page
            alert(`Viewing evidence ID: ${evidenceId}\n\nThis would open the evidence detail page.`);
        }

        // Initialize timeline when page loads
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            initializeTimeline();
        });
    </script>
</body>
</html>